<script lang="ts">
import { defineComponent, onMounted, ref } from '@vue/composition-api'
import { useRoute } from 'vue-router/composables'
import {
  type ParentToChild,
  type ChildToParent,
  BridgeFrame
} from '@passerelle/enclosure-vue'

export default defineComponent({
  components: {
    BridgeFrame
  },
  setup() {
    const route = useRoute()

    const defaultPath = `http://localhost:5174${extractChildPath(route.path)}`

    function extractChildPath(path: string): string {
      const [, matchedPath] = /^\/bridge(\/.*?)$/.exec(path) ?? []
      if (!matchedPath) {
        throw new Error(`invalid path: ${path}`)
      }
      return matchedPath
    }

    const parentToChild: ParentToChild = (location) => {
      return extractChildPath(location.path)
    }

    const childToParent: ChildToParent = ({ path, params }) => {
      return { path: `/bridge${path}`, params }
    }

    const bridge = ref()

    onMounted(() => {
      // デバッグのためにわざと window を介してルートに communicator を公開している
      ;(window as any).getCommunicator = () => bridge.value.getCommunicator()
    })
    return {
      defaultPath,
      parentToChild,
      childToParent,
      bridge
    }
  }
})
</script>

<template>
  <BridgeFrame
    class="frame"
    ref="bridge"
    communicate-key="passerelle-playground"
    :initial-src="defaultPath"
    :to-child-path="parentToChild"
    :to-parent-path="childToParent"
    required-collab />
</template>

<style scoped>
.frame {
  border: 1px solid var(--color-border);
}
</style>
